
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Participant {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  firstname    String
  lastname     String
  receipts     Receipt[]
  bonusPayouts BonusPayout[]
}

model Category {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  // Mode can be 'PER_ITEM' or 'PER_CATEGORY'
  mode      String
  products  Product[]
  tierRules TierRule[]
}

model Product {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  price      Float
  category   Category  @relation(fields: [categoryId], references: [id])
  categoryId String    @db.ObjectId
  receipts   Receipt[]
}

model TierRule {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  category        Category @relation(fields: [categoryId], references: [id])
  categoryId      String   @db.ObjectId
  minQuantity     Int
  bonusPercentage Float
}

model Receipt {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  participant   Participant @relation(fields: [participantId], references: [id])
  participantId String      @db.ObjectId
  product       Product     @relation(fields: [productId], references: [id])
  productId     String      @db.ObjectId
  date          DateTime    @default(now())
  price         Float
}

model BonusPayout {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  participant   Participant @relation(fields: [participantId], references: [id])
  participantId String      @db.ObjectId
  amount        Float
  potentialBonus Float      @map("potential_bonus") // What they would have earned
  breakdown     Json        // Detailed category breakdown
  period        String      // "2024-01" format
  month         Int
  year          Int
  forecastMet   Boolean     @map("forecast_met")
  totalRevenue  Float       @map("total_revenue")
  targetRevenue Float       @map("target_revenue")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("bonus_payouts")
}


model Forecast {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  month        Int
  year         Int
  targetAmount Float
  // Threshold as a decimal percentage, e.g. 0.9 for 90%
  threshold    Float
}

// Authentication Models
model User {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  username     String        @unique
  email        String        @unique
  firstname    String
  lastname     String
  role         String        // "admin" | "operations" | "finance"
  passwordHash String        @map("pwd_hash")
  isActive     Boolean       @default(false) @map("is_active")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  inviteTokens InviteToken[]
  accessTokens AccessToken[]

  @@map("users")
}

model InviteToken {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @map("user_id") @db.ObjectId
  tokenHash String    @map("token_hash")
  jti       String    @unique // JWT ID for tracking
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invite_tokens")
}

model AccessToken {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @map("user_id") @db.ObjectId
  tokenHash String    @map("token_hash")
  jti       String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("access_tokens")
}

